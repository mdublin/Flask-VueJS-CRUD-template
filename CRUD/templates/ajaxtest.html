<!-- importing macros.html as macros which is a macro used for handling each entry in the blogful db -->
{% import "CRUD_macros.html" as macros %}

<!-- The extends informs the templating engine that this template “extends” another template, base.html, establishing a link between the templates. This sends what the code below does over to base.html -->
{% extends "base.html" %}


{% block content %}

<script type="text/javascript" src="https://npmcdn.com/vue@1.0.26/dist/vue.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<!--
<ul id="test">
  <template v-for="item in items" track-by="$index">
	  <li>${ item.firstname }</li>
    <li class="divider"></li>
  </template>
</ul>

-->

	   <!-- </template> -->
<div v-for="(index, item) in items" id="test2">

<div class="list-group" id="test">
	<!--	<template v-for="item in items" track-by="$index"> -->
	<a href="#" class="list-group-item active">
	  <b>Name:</b> ${ item.firstname} ${ item.lastname }</a>
      <a href="#" class="list-group-item"><b>DOB:</b> ${ item.dob }</a>
	  <a href="#" class="list-group-item"><b>postal code:</b> ${ item.zipcode }</a>
	  <a class="list-group-item"><button type="button" class="btn btn-danger" data-toggle="modal" data-target="#DeleteModal--${ $index }">DELETE</button>
		  <button type="button" class="btn btn-info" id="updateButton -- ${ $index }" data-toggle="modal" data-target="#UpdateModal--${ $index }">UPDATE</button></a>
	  <br></br>
</div>
	   

<!-- DELETE Modal -->
<!-- <form action={{ url_for('searchpeople') }} role="form" method="POST"> -->
<form action="" role="form" method="POST" name="delete -- ${$index}" id="delete -- ${$index}"> 
	<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
	  <div class="modal fade" id="DeleteModal--${ $index }" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
		<div class="modal-content" id="del--${ $index }">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title-warning" id="myModalLabel">Are you sure you want to delete this person?</h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger" name="delete_id" value="${ item.id }">Confirm Delete</button>
            </div>
        </div>
    </div>
</div>
</form>


<!-- UPDATE Modal -->

<form action="" method="POST" enctype="multipart/form-data" name="updateForm" id="updateForm--${$index}">
	<!-- <form name="updateForm" id="updateForm"> -->
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" /> 	
<input type="hidden" name="vue_page_index" value="${$index}" />
<div class="modal fade" id="UpdateModal--${ $index }" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
			<div class="modal-content" id="${ $index }">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
					</button>

					<b>First name: </b><input class="form-control" type="text" name="firstname" id="${ $index }" placeholder="${ item.firstname }">
                    <b>Last Name: </b><input class="form-control" type="text" name="lastname" placeholder="${ item.lastname }">
                    <b>DOB: </b><input class="form-control" type="text" name="DOB" placeholder="${ item.dob }" >
                    <b>Postal code: </b><input class="form-control" type="text" name="zipcode" placeholder="${ item.zipcode }">
                        <input type="hidden" name="db_id" value="${ item.id }" />
					</div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
					<button type="submit" id="updateButton" class="btn btn-success">Save Changes</button>
					<button type="submit" v-on:click="updateFormButton($index, $event)" class="btn btn-success" >Save Changes</button>

					
                </div>
            </div>
        </div>
    </div>
</form>

<!--</template>-->

</div>



	<ul class="pager">
		<li class="previous" id="previous">
			<a href="javascript:prevPage()" id="btn_prev">Previous</a>
		</li>
		<li class="next" id="next">
			<a href="javascript:nextPage()" id="btn_next">Next</a>
		</li>
	</ul>


	
	
<script>

var itemsArray = [];

Vue.config.delimiters = ["${", "}"];

var vm = new Vue({
	el: '#test2',
	data: {
		parentMessage: 'Parent',
		items: itemsArray
		//items: [
		//	{ message: 'Foo' },
		//	{ message: 'Bar' }
		//]
	},
	
	methods: {
		updateFormButton: function (msg, event) {
			//console.log(msg);
			//alert(msg);
		// `this` inside methods point to the Vue instance
	        //alert('Hello ' + this.name + '!');
			// `event` is the native DOM event
			//alert(event.target.tagName);
		     event.preventDefault();
	         ajaxTest(msg, event);
			 //event.preventDefault();

		},
		
	}

});



function updateVueInstance(itemsArray) {
	vm.items = itemsArray;
	console.log("updateVueInstance being called!!!");
	//getFormCallback();

}


// GET request to listpeople general load endpoint 
function queryCall(currentPage) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
		console.log("calling function");

		console.log(xhr.readyState);

		if(xhr.readyState == XMLHttpRequest.DONE) {
			//alert(xhr.responseText);
			//console.log(xhr.response);

		    //apiResponse = xhr.responseText;

		    apiResponse = xhr.response;
			// converting json server response string to json object
			apiResponse = JSON.parse(apiResponse);

			//console.log(apiResponse);

		    itemsArray = [];

			for(var i = 0; i < apiResponse.length; i++){
				console.log(apiResponse[i]);
			}

			for (var entry in apiResponse) {
				console.log("Adding to itemsArray...")
				console.log(apiResponse[entry]);
				itemsArray.push(apiResponse[entry]);
			}
  

			console.log(itemsArray);
			updateVueInstance(itemsArray);

				}
	}

	var params = "?page="+encodeURIComponent(currentPage);
	xhr.open("GET", "/listpeople"+params);
	//xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	xhr.send();
}












var currentPage = 1;

function nextPage() {
	currentPage++;
	console.log("currentPage number: " + currentPage);
	//currentPage = currentPage;
	if (currentPage > 1){
	    $("#previous").show();
	}
	queryCall(currentPage);
}

// hide prev button on page load
if (currentPage <= 1){
	$("#previous").hide();
}


function prevPage() {
	currentPage--;
	console.log("currentPage number: " + currentPage);
	queryCall(currentPage);
	
}



// loading results on page load
window.addEventListener("load", function load(event) {
	queryCall(currentPage);
});




function ajaxTest(msg, event){
	
	console.log("ajaxTest called!!!");
	

	console.log(msg);
	
	var indexNum = msg;
	console.log("this is indexNum: " + indexNum);


	//var form = document.forms.namedItem("updateForm");
    var form = document.getElementById("updateForm--"+indexNum);

    console.log(form);

	var oReq = new XMLHttpRequest();

	oReq.onload = function(oEvent) {
		if(oReq.status == 200) {
			console.log("DONE");
			$('#UpdateModal--'+indexNum).modal('hide');
			console.log("Updated db entry: " + oReq.response);
			apiResponse = JSON.parse(oReq.response);
	
			console.log("now updating vue instance....");
			var vueIndex = apiResponse['entry_vue_page_$index'];
			console.log(vueIndex);

			vm.items.$set(vueIndex, {firstname: apiResponse[vueIndex]["firstname"], lastname: apiResponse[vueIndex]["lastname"], dob: apiResponse[vueIndex]["dob"], zipcode: apiResponse[vueIndex]["zipcode"], db_id: apiResponse[vueIndex]["id"]});

		} else {
			console.log("There's a problem");
		}
	};
			
	oData = new FormData(form);
	console.log(oData.values());
  oReq.open("POST", "/searchpeople", true);
  oReq.send(oData);
  //event.preventDefault();

}






</script>


{% endblock %}



